<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noâ€‘Mercy Card Match (UNOâ€‘like)</title>
  <style>
    :root{
      --bg:#0f1226;--card:#171a33;--muted:#9aa3b2;--accent:#7c5cff;--good:#22c55e;--bad:#ef4444;--warn:#f59e0b;--panel:#111428;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:radial-gradient(60rem 60rem at 80% -10%,#23294f,transparent),radial-gradient(70rem 70rem at -10% 110%,#1b2040,transparent),var(--bg); color:#e6e8ef}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:12px;flex-wrap:wrap}
    h1{font-size:clamp(20px,4vw,28px);margin:0}
    .pill{padding:6px 10px;background:linear-gradient(135deg,#2a2e57,#1b1f3f);border:1px solid #2d325f;border-radius:999px;color:#cbd5e1;font-size:12px}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.00));border:1px solid #2a2d52;border-radius:16px;padding:16px}
    .grid{display:grid;gap:16px}
    @media(min-width:880px){.grid{grid-template-columns:360px 1fr}}
    input,button,select{font:inherit}
    input[type=text]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a2d52;background:#0d1030;color:#e6e8ef}
    button{border:1px solid #2d325f;border-radius:12px;padding:10px 14px;background:#171a33;color:#e6e8ef;cursor:pointer}
    button.primary{background:linear-gradient(135deg,#6d5cff,#945cff);border-color:#7c5cff}
    button.ghost{background:transparent}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:13px}
    .label{font-size:12px;color:#cbd5e1;margin-bottom:6px}
    .invite{display:none;gap:8px;align-items:center;background:#12163a;border:1px solid #2a2d52;border-radius:12px;padding:8px 12px}
    .invite .code{font-weight:700;background:#0c1030;border:1px solid #2a2d52;border-radius:8px;padding:6px 10px}
    .warn{color:var(--warn)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .table{display:grid;gap:16px}
    @media(min-width:640px){.table{grid-template-columns: 1fr 320px}}
    .players{display:flex;flex-direction:column;gap:8px}
    .player{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid #272a50;border-radius:12px;padding:10px}
    .player.me{outline:2px solid var(--accent)}
    .player .name{font-weight:600}
    .badge{padding:2px 8px;border-radius:999px;border:1px solid #2d325f;background:#14173a;color:#cbd5e1;font-size:12px}
    .current{border-color:#9f7aea;box-shadow:0 0 0 2px rgba(124,92,255,.35) inset}
    .board{background:conic-gradient(from 0deg,#ff4d4d 0 25%,#3ecf8e 0 50%,#ffd166 0 75%,#60a5fa 0 100%);border-radius:16px;padding:14px}
    .board-inner{background:#0e1231b8;border:1px dashed #3a3f71;padding:16px;border-radius:12px;min-height:220px;display:grid;place-items:center}
    .pile{display:flex;gap:12px;align-items:center}
    .card{width:70px;height:110px;border-radius:12px;background:#fff;display:grid;place-items:center;color:#111;font-weight:800;font-size:28px;box-shadow:0 10px 24px rgba(0,0,0,.2);position:relative}
    .card .sym{font-size:36px}
    .card .tiny{position:absolute;top:6px;left:8px;font-size:12px;font-weight:700}
    .card.red{background:#ff4d4d;color:#fff}
    .card.green{background:#22c55e;color:#fff}
    .card.blue{background:#3b82f6;color:#fff}
    .card.yellow{background:#f59e0b;color:#111}
    .card.wild{background:linear-gradient(135deg,#222,#444);color:#fff}
    .card.outline{border:2px dashed #94a3b8;background:transparent;color:#94a3b8;box-shadow:none}
    .hand{display:flex;gap:8px;flex-wrap:wrap}
    .log{height:200px;overflow:auto;background:#0d1030;border:1px solid #2a2d52;border-radius:12px;padding:10px;font-size:13px}
    .small{font-size:12px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#15183a;border:1px solid #2d325f;padding:10px 14px;border-radius:999px;color:#cbd5e1;box-shadow:0 10px 24px rgba(0,0,0,.3);display:none}
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Noâ€‘Mercy Card Match <span class="pill">UNOâ€‘like â€¢ Crossâ€‘platform</span></h1>
      <div class="muted small">Host on GitHub Pages â€¢ Realtime via Firebase</div>
      <div id="inviteBar" class="invite">
        <span class="muted small">Room:</span>
        <span id="roomCode" class="code">â€”</span>
        <button id="copyInviteBtn">Copy invite link</button>
      </div>
    </header>

    <div class="grid">
      <section class="panel" id="lobbyPanel">
        <div class="label">Display name</div>
        <input id="nameInput" type="text" placeholder="e.g., Gaibul" />
        <div class="label" style="margin-top:12px">Create or join a room</div>
        <div class="row">
          <button class="primary" id="createRoomBtn">Create room</button>
          <input id="roomInput" type="text" placeholder="Enter room code" style="max-width:160px" />
          <button id="joinRoomBtn">Join</button>
          <button class="ghost" id="copyRoomBtn" title="Copy room link" disabled>Copy link</button>
        </div>
        <div class="row" style="margin-top:10px">
          <label class="row small"><input type="checkbox" id="noMercyToggle" checked /> Noâ€‘Mercy mode (stack Draw +2/+4)</label>
          <label class="row small"><input type="checkbox" id="jumpInToggle" /> Jumpâ€‘In (play identical card out of turn)</label>
          <label class="row small"><input type="checkbox" id="swap70Toggle" /> 7â€‘0 (swap hands on 7, rotate on 0)</label>
        </div>
        <p class="muted small" style="margin-top:10px">This is an independent fanâ€‘made, UNOâ€‘like card game. Not affiliated with Mattel.</p>
      </section>

      <section class="panel table" id="tablePanel" style="display:none">
        <div class="players" id="players"></div>
        <div>
          <div class="board">
            <div class="board-inner">
              <div>
                <div class="pile">
                  <div id="discardTop" class="card outline"><span class="tiny">DISC</span><span>â€“</span></div>
                  <div id="drawPile" class="card outline"><span class="tiny">DRAW</span><span>âˆž</span></div>
                </div>
                <div class="row" style="justify-content:center;margin-top:10px">
                  <button class="primary" id="startBtn">Start game</button>
                  <button id="drawBtn">Draw</button>
                  <button id="passBtn">Pass</button>
                  <select id="wildColor" style="display:none">
                    <option value="red">Red</option>
                    <option value="green">Green</option>
                    <option value="blue">Blue</option>
                    <option value="yellow">Yellow</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <h3 style="margin:14px 0 8px">Your hand</h3>
          <div class="hand" id="hand"></div>

          <h3 style="margin:14px 0 8px">Game log</h3>
          <div class="log" id="log"></div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <script type="module">
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAEqutXCO5OZD6VU_ohaBxNfh7G8Q6PEy0",
      authDomain: "nomercy-8269a.firebaseapp.com",
      databaseURL: "https://nomercy-8269a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nomercy-8269a",
      storageBucket: "nomercy-8269a.firebasestorage.app",
      messagingSenderId: "349047620790",
      appId: "1:349047620790:web:3206ff81cb7f5413d29217",
      measurementId: "G-1WX7CWBFGF"
    };
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();

    const $ = s => document.querySelector(s);
    const logEl = $('#log');
    function log(msg){ const p=document.createElement('div'); p.textContent=msg; logEl.appendChild(p); logEl.scrollTop=logEl.scrollHeight; }
    function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }

    const COLORS = ['red','green','blue','yellow'];
    const VALUES = ['0','1','2','3','4','5','6','7','8','9','S','R','+2'];

    function makeDeck(){
      const deck=[];
      for(const c of COLORS){
        deck.push({t:'num',c,v:'0'});
        for(const v of VALUES.filter(v=>v!=='0')){
          deck.push({t: v.match(/\\+2|S|R/) ? 'act' : 'num', c, v});
          deck.push({t: v.match(/\\+2|S|R/) ? 'act' : 'num', c, v});
        }
      }
      for(let i=0;i<4;i++){deck.push({t:'wild',v:'W'});deck.push({t:'wild',v:'+4'});}
      for(let i=0;i<4;i++) deck.push({t:'wild',v:'+6'});
      for(let i=0;i<2;i++) deck.push({t:'wild',v:'+10'});
      return shuffle(deck);
    }
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    function uid(){return Math.random().toString(36).slice(2,9)}

    let myId=localStorage.getItem('nm_me')||uid();
    localStorage.setItem('nm_me',myId);
    let myName=localStorage.getItem('nm_name')||'';
    $('#nameInput').value=myName;

    let roomId=null, isHost=false, unsub=null;

    const inviteBar = $('#inviteBar');
    const roomCodeEl = $('#roomCode');
    const copyInviteBtn = $('#copyInviteBtn');

    function updateInviteBar(){
      if(!roomId){ inviteBar.style.display='none'; return; }
      roomCodeEl.textContent = roomId;
      inviteBar.style.display='flex';
    }
    function currentInviteLink(){
      return `${location.origin}${location.pathname}?room=${roomId}`;
    }
    copyInviteBtn.onclick = ()=>{
      if(!roomId) return;
      navigator.clipboard.writeText(currentInviteLink());
      toast('Invite link copied');
    };

    $('#createRoomBtn').onclick=async()=>{
      myName = $('#nameInput').value.trim()||`Player_${myId.slice(0,4)}`;
      localStorage.setItem('nm_name',myName);
      const id = (Math.random().toString(36).slice(2,6)+Math.random().toString(36).slice(2,6)).toUpperCase();
      roomId=id; isHost=true;
      const roomRef=db.ref(`rooms/${roomId}`);
      const base={
        created: Date.now(),
        opts:{ noMercy: $('#noMercyToggle').checked, jumpIn: $('#jumpInToggle').checked, swap70: $('#swap70Toggle').checked },
        host: myId,
        started:false,
        turn:0, dir:1, drawStack:0, currentColor:null,
        players:{},
        deck:[], discard:[],
        chat:[]
      };
      await roomRef.set(base);
      await addPlayer();
      enterTable();
      updateInviteBar();
      toast(`Room ${roomId} created`);
      // also copy automatically once
      try{ await navigator.clipboard.writeText(currentInviteLink()); toast('Invite link copied'); }catch{}
    };

    $('#joinRoomBtn').onclick=async()=>{
      const id=$('#roomInput').value.trim().toUpperCase();
      if(!id){toast('Enter a room code');return}
      const snap=await db.ref(`rooms/${id}`).get();
      if(!snap.exists()){toast('Room not found');return}
      roomId=id; isHost = (snap.val().host===myId);
      await addPlayer();
      enterTable();
      updateInviteBar();
    };
    $('#copyRoomBtn').onclick=()=>{
      if(!roomId){toast('Create or join a room first'); return;}
      navigator.clipboard.writeText(currentInviteLink()); toast('Invite link copied');
    }

    async function addPlayer(){
      myName = $('#nameInput').value.trim()||`Player_${myId.slice(0,4)}`;
      localStorage.setItem('nm_name',myName);
      const p={id:myId,name:myName,hand:[],joined:Date.now(),cardCount:0};
      await db.ref(`rooms/${roomId}/players/${myId}`).set(p);
    }

    function enterTable(){
      $('#lobbyPanel').style.display='none';
      $('#tablePanel').style.display='grid';
      $('#startBtn').style.display = isHost? 'inline-block':'none';
      $('#copyRoomBtn').disabled=false;
      if(unsub) unsub();
      const ref=db.ref(`rooms/${roomId}`);
      const handler = (snap)=>{ if(!snap.exists()) return; render(snap.val()); };
      ref.on('value', handler);
      unsub = ()=> ref.off('value', handler);
      history.replaceState({},'',`?room=${roomId}`);
    }

    (function(){
      const u=new URL(location.href);
      const rid=u.searchParams.get('room');
      if(rid){ $('#roomInput').value=rid; }
    })();

    $('#startBtn').onclick=async()=>{
      const rRef=db.ref(`rooms/${roomId}`);
      const snap=await rRef.get();
      const r=snap.val();
      if(!isHost){ toast('Only host can start'); return }
      const ids=Object.keys(r.players||{});
      if(ids.length<2){ toast('Need at least 2 players'); return }
      let deck=makeDeck();
      for(const pid of ids){ r.players[pid].hand=[] }
      for(let i=0;i<7;i++) for(const pid of ids){ r.players[pid].hand.push(deck.pop()) }
      let first=deck.pop();
      while(first.t==='wild' || (first.t==='act' && first.v.match(/S|R|\\+2/))){ deck.unshift(first); deck=shuffle(deck); first=deck.pop(); }
      r.discard=[first]; r.currentColor=first.c; r.turn=0; r.dir=1; r.drawStack=0; r.started=true; r.deck=deck;
      await rRef.set(r);
      log('Game started');
    };

    $('#drawBtn').onclick=()=> doDraw();
    $('#passBtn').onclick=()=> doPass();

    async function doDraw(){
      const rRef=db.ref(`rooms/${roomId}`);
      await rRef.transaction(r=>{
        if(!r||!r.started) return r;
        const ids=Object.keys(r.players||{});
        if(ids.length===0) return r;
        const cur=ids[r.turn];
        if(cur!==myId) return r;
        const n = r.drawStack>0? r.drawStack : 1;
        for(let i=0;i<n;i++){
          if(r.deck.length===0){
            const top=r.discard.pop();
            r.deck = shuffle(r.discard);
            r.discard=[top];
          }
          r.players[cur].hand.push(r.deck.pop());
        }
        r.drawStack=0;
        r.turn = ((r.turn + r.dir) % ids.length + ids.length) % ids.length;
        return r;
      });
    }

    async function doPass(){
      const rRef=db.ref(`rooms/${roomId}`);
      await rRef.transaction(r=>{
        if(!r||!r.started) return r;
        const ids=Object.keys(r.players||{});
        if(ids.length===0) return r;
        const cur=ids[r.turn];
        if(cur!==myId) return r;
        r.turn = ((r.turn + r.dir) % ids.length + ids.length) % ids.length;
        return r;
      });
    }

    function canPlay(card, top, currentColor){
      if(card.t==='wild') return true;
      if(card.c===currentColor) return true;
      if(top && top.t==='wild'){ return card.c===currentColor; }
      if(top && card.c===top.c) return true;
      if(top && card.v===top.v) return true;
      return false;
    }

    async function playCard(idx, chooseColor){
      const rRef=db.ref(`rooms/${roomId}`);
      await rRef.transaction(r=>{
        if(!r||!r.started) return r;
        const ids=Object.keys(r.players||{});
        if(ids.length===0) return r;
        const curIdx=r.turn; const cur=ids[curIdx];
        if(cur!==myId) return r;
        const hand=r.players[cur].hand;
        const card=hand[idx]; if(!card) return r;

        const top=r.discard[r.discard.length-1];
        const ok = canPlay(card, top, r.currentColor || top?.c);
        if(!ok) return r;

        hand.splice(idx,1);
        r.discard.push(card);
        if(card.t==='wild'){
          const color = chooseColor || r.currentColor || 'red';
          r.currentColor=color;
          if(card.v==='+4') r.drawStack += 4;
          if(card.v==='+6') r.drawStack += 6;
          if(card.v==='+10') r.drawStack += 10;
        }else{
          r.currentColor=card.c;
          if(card.t==='act'){
            if(card.v==='S'){
              r.turn = ((r.turn + r.dir) % ids.length + ids.length) % ids.length;
            } else if(card.v==='R'){
              r.dir = -r.dir;
              if(ids.length===2) {
                r.turn = ((r.turn + r.dir) % ids.length + ids.length) % ids.length;
              }
            } else if(card.v==='+2'){
              r.drawStack += 2;
            }
          }
          if($('#swap70Toggle').checked){
            if(card.v==='7'){
              let smallestId=cur; let min=hand.length;
              for(const pid of ids){
                const len=r.players[pid].hand.length;
                if(pid!==cur && len<min){ min=len; smallestId=pid; }
              }
              const tmp=r.players[smallestId].hand; r.players[smallestId].hand=r.players[cur].hand; r.players[cur].hand=tmp;
            }
            if(card.v==='0'){
              const hands=ids.map(pid=>r.players[pid].hand);
              if(r.dir===1){ hands.unshift(hands.pop()); } else { hands.push(hands.shift()); }
              ids.forEach((pid,i)=> r.players[pid].hand = hands[i]);
            }
          }
        }

        if(r.players[cur].hand.length===0){
          r.started=false; r.winner=cur; return r;
        }

        r.turn = ((r.turn + r.dir) % ids.length + ids.length) % ids.length;
        return r;
      });
    }

    function render(r){
      if(!r) return;
      const ids=Object.keys(r.players||{});
      const playersEl=$('#players'); playersEl.innerHTML='';
      ids.forEach((pid,i)=>{
        const p=r.players[pid];
        const div=document.createElement('div'); div.className='player'+(pid===myId?' me':'')+(r.started && i===r.turn?' current':''); 
        const left=document.createElement('div'); left.className='row';
        const nm=document.createElement('div'); nm.className='name'; nm.textContent=p.name||pid;
        const cards=document.createElement('div'); cards.className='badge'; cards.textContent=(p.hand?.length||0)+' cards';
        left.append(nm);
        div.append(left,cards);
        playersEl.append(div);
      });

      const top=r.discard?.[r.discard.length-1];
      const topEl=$('#discardTop');
      if(top){
        topEl.className=`card ${top.t==='wild'?'wild':top.c}`;
        topEl.innerHTML=`<span class="tiny">DISC</span><span class="sym">${top.v||''}</span>`
      }
      const drawEl=$('#drawPile');
      drawEl.onclick=()=> $('#drawBtn').click();

      $('#startBtn').style.display = (isHost && !r.started)? 'inline-block':'none';
      $('#drawBtn').style.display = r.started? 'inline-block':'none';
      $('#passBtn').style.display = r.started? 'inline-block':'none';

      const me=r.players?.[myId];
      const handEl=$('#hand'); handEl.innerHTML='';
      const currentColor=r.currentColor || top?.c;
      me?.hand?.forEach((card,idx)=>{
        const b=document.createElement('button'); b.className='card '+(card.t==='wild'?'wild':card.c);
        b.innerHTML=`<span class="tiny">YOU</span><span class="sym">${card.v}</span>`;
        const myTurn = r.started && Object.keys(r.players||{})[r.turn]===myId;
        b.disabled = !(myTurn && canPlay(card, top, currentColor));
        b.onclick=()=>{
          if(card.t==='wild'){
            $('#wildColor').style.display='inline-block';
            $('#wildColor').onchange=(e)=>{ playCard(idx,e.target.value); e.target.style.display='none'; };
            toast('Pick a color for your wild');
          } else { playCard(idx); }
        };
        handEl.appendChild(b);
      });

      if(r.winner){ log(`ðŸŽ‰ ${r.players[r.winner].name} wins!`); }
      if(r.drawStack>0){
        drawEl.classList.remove('outline');
        drawEl.innerHTML = `<span class="tiny">DRAW</span><span class="sym">+${r.drawStack}</span>`;
      } else {
        drawEl.classList.add('outline');
        drawEl.innerHTML = `<span class="tiny">DRAW</span><span>âˆž</span>`;
      }

      updateInviteBar();
    }
  </script>
</body>
</html>
